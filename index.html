<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>VOD配信・Live配信の裏側</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/dist/reveal.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/dist/theme/white.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/plugin/highlight/monokai.css"
    />
    <!-- Video.js CSS -->
    <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet" />
    <style>
      .reveal {
        background-color: #ffffff;
      }
      .reveal .slides section {
        text-align: left;
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-color: #ffffff;
      }
      .reveal h1,
      .reveal h2,
      .reveal h3 {
        text-align: left;
        color: #6e5a40;
        margin: 30px 0 20px 0;
        font-size: 1.2em;
        flex-shrink: 0;
      }
      .reveal h1 {
        font-size: 1.5em;
      }
      .reveal h3 {
        font-size: 0.8em;
      }
      .reveal .title-slide {
        text-align: center;
        justify-content: center;
      }
      .reveal .title-slide h1,
      .reveal .title-slide h2,
      .reveal .title-slide h3 {
        text-align: center;
      }

      .reveal ul {
        padding: 0px;
        margin: 0px;
      }

      .reveal ul,
      .reveal ol,
      .reveal p {
        font-size: 0.7em;
        flex-grow: 1;
        color: #333333;
      }
      .reveal li {
        color: #333333;
      }
      .reveal .slides section > * {
        margin-bottom: 15px;
      }
      .two-column {
        display: flex;
        align-items: flex-start;
        gap: 100px;
      }
      .two-column .column {
        flex: 1;
      }
      .two-column pre code {
        width: 100%;
        padding-left: 2rem;
        font-size: 0.4em;
      }
      pre code {
        padding-left: 2rem;
        font-size: 0.6em;
      }
      .accent-color {
        color: #e55050 !important;
      }
      .vjs-default-skin {
        width: 100%;
        height: 50%;
      }
    </style>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <!-- タイトルスライド -->
        <section class="title-slide">
          <h1>VOD配信・Live配信の裏側</h1>
          <p>ストリーミング技術の基礎</p>
        </section>

        <!-- 概要 -->
        <section>
          <h2>今日のトピック</h2>
          <ul>
            <li>VOD配信とは</li>
            <li>Live配信とは</li>
            <li>内部で使用されているプロトコル</li>
            <li>Http Live Streaming (HLS)</li>
          </ul>
        </section>

        <!-- VOD配信 -->
        <section>
          <h2>VOD配信</h2>
          <ul>
            <li>事前に録画された動画コンテンツ</li>
            <li>ユーザーが好きな時に視聴可能</li>
            <li>一時停止、早送り、巻き戻しが可能</li>
            <li>Netflix、YouTube、Amazon Prime Videoなど</li>
          </ul>
          <pre><code class="javascript" data-line-numbers="1-5|2|3|4,5">
// VOD配信の基本的な再生コード例
const video = document.querySelector('video');
video.src = 'https://example.com/video.mp4';
video.load();
video.play();
          </code></pre>
        </section>

        <!-- Live配信 -->
        <section>
          <h2>Live配信</h2>
          <ul>
            <li>リアルタイムで配信される動画</li>
            <li>生放送、ライブストリーミング</li>
            <li>低遅延が重要</li>
            <li>Twitch、YouTube Live、ニコニコ生放送など</li>
          </ul>
        </section>

        <!-- プロトコル -->
        <section>
          <h2>内部で使用されているプロトコル</h2>
          <ul>
            <li><strong>HLS (HTTP Live Streaming)</strong></li>
            <li>DASH (Dynamic Adaptive Streaming over HTTP)</li>
            <li>RTMP (Real-Time Messaging Protocol)</li>
            <li>WebRTC (Web Real-Time Communication)</li>
          </ul>
        </section>

        <!-- HLS詳細 -->
        <section>
          <h2>HTTP Live Streaming (HLS)</h2>
        </section>

        <!-- 動画デモ -->
        <section>
          <h2>video tagですぐ実装できるやん</h2>
          <div class="two-column">
            <div class="column">
              <pre><code class="html">
&lt;video controls&gt;
  &lt;source src="video.mp4" type="video/mp4"&gt;
&lt;/video&gt;
              </code></pre>
              <ul>
                <li>HTMLのvideo要素で簡単実装</li>
                <li>ブラウザが自動で動画を処理</li>
                <li>コントロールバーも自動表示</li>
              </ul>
            </div>
            <div class="column">
              <video width="100%" height="300" controls>
                <source
                  src="https://video-playground-takata.s3.ap-southeast-2.amazonaws.com/loop-100-video.mp4"
                  type="video/mp4"
                />
                お使いのブラウザは動画タグをサポートしていません。
              </video>
            </div>
          </div>
        </section>

        <!-- 動画デモ -->
        <section>
          <h2>ブラウザごとにvideo tagの挙動異なる</h2>
          <p>動画再生frameworkを使用して差分を吸収</p>
          <video width="800" height="450" controls>
            <source
              src="video/mp4/199596-910653729_small.mp4"
              type="video/mp4"
            />
            お使いのブラウザは動画タグをサポートしていません。
          </video>
        </section>

        <!-- データフロー図 -->
        <section>
          <h2>ブラウザがS3から動画を取得する流れ</h2>
          <pre class="mermaid">
            sequenceDiagram
                participant User as ユーザー
                participant Browser as ブラウザ
                participant S3 as Amazon S3
                
                User->>Browser: 動画再生ボタンクリック
                Browser->>S3: HTTP GET request /bucket/video.mp4
                S3-->>Browser: HTTP 200 OK Content-Type: video/mp4
                Browser->>Browser: 動画デコード
                Browser->>User: 動画再生開始
          </pre>
        </section>

        <!-- 動画デモ -->
        <section>
          <h2>動画配信デモ</h2>
          <p>なんでクソでかい動画でもすぐに再生できるの？？</p>
          <p class="fragment accent-color">
            A. Http HeaderのRange,
            Content-Rangeとプログレッシブダウンロードを利用しているから
          </p>
          <video width="800" height="450" controls>
            <source
              src="https://video-playground-takata.s3.ap-southeast-2.amazonaws.com/video/mediaconvert/output.m3u8"
              type="video/mp4"
            />
            お使いのブラウザは動画タグをサポートしていません。
          </video>
        </section>

        <!-- 動画デモ -->
        <section>
          <h2>MP4の動画を再生だと困ること</h2>
          <h3>解像度の種類が1つしか選択できない</h3>
          <p>
            =>
            スマホで電波の悪いところで、高解像度のmp4を再生しようとすると全然再生できない🥺
          </p>

          <h3>ライブ配信がwebで見れない..</h3>
          <p>
            => ライブが終わってmp4をサーバーにアップロードするまで見れない🥺
          </p>

          <h3 class="fragment accent-color">
            HTTP Live Streaming (HLS)を使うと解決できるよ！
          </h3>
        </section>

        <!-- HLS特徴 -->
        <section>
          <h3>HLSの特徴</h3>
          <ul>
            <li>HTTPベースのプロトコル</li>
            <li>動画を小さなセグメントに分割</li>
            <li>プレイリスト（.m3u8）で管理</li>
            <li>アダプティブビットレート対応</li>
            <li>CDNとの相性が良い</li>
          </ul>
        </section>

        <!-- HLS仕組み -->
        <section>
          <h3>HLSの仕組み</h3>
          <ol>
            <li>動画を小さなセグメント（.ts）に分割</li>
            <li>プレイリストファイル（.m3u8）を作成</li>
            <li>クライアントがプレイリストを取得</li>
            <li>セグメントを順次ダウンロード・再生</li>
            <li>ネットワーク状況に応じて品質を調整</li>
          </ol>
        </section>

        <!-- HLS仕組み -->
        <section>
          <h3>HLSを再生するにはどうしたらいい？？</h3>
          <h3 class="fragment accent-color">
            safariだとvideo tagでHLSの再生できるよ！
          </h3>
          <pre><code class="html">
&lt;video controls&gt;
&lt;source 
  src="https://video-playground-takata.s3.ap-southeast-2.amazonaws.com/video/mediaconvert/output.m3u8" 
  type="application/x-mpegURL" /&gt;
&lt;/video&gt;
          </code></pre>

          <video width="600" height="200" controls>
            <source
              src="https://video-playground-takata.s3.ap-southeast-2.amazonaws.com/video/mediaconvert/output.m3u8"
              type="application/x-mpegURL"
            />
            お使いのブラウザは動画タグをサポートしていません。
          </video>
          <h3 class="fragment accent-color">
            他のブラウザだとHLSの再生できない🥺
          </h3>
        </section>

        <!-- Video.js HLS Demo -->
        <section>
          <h3>Video.jsを使ってクロスブラウザでHLS再生</h3>

          <video-js
            id="videojs-hls-player"
            class="vjs-default-skin"
            controls
            preload="auto"
          >
          </video-js>
        </section>

        <!-- Video.js HLS Demo -->
        <section>
          <h3>普通のHLSだと誰でも、データをダウンロードできる</h3>
          <!-- 
          <a href="https://pivotmedia.co.jp/movie/13116"
            >https://pivotmedia.co.jp/movie/13116</a
          > -->

          <p>
            network tagを開いて、manifest fileを特定して、claude
            codeとかに頼めば、localに保存してくれる
          </p>
          <pre><code>
           ${manifest_file_url} の動画をmp4でlocalに保存して 
          </code></pre>
        </section>

        <!-- DRM explanation -->
        <section>
          <h3>DRM (Digital Rights Management)</h3>
          <ul>
            <li><strong>デジタル著作権管理</strong>技術</li>
            <li>コンテンツの不正ダウンロード・複製を防ぐ</li>
            <li>動画データを暗号化して保護</li>
            <li>ライセンスサーバーでアクセス制御</li>
          </ul>

          <h3>主要なDRM方式</h3>
          <ul>
            <li>
              <strong>Widevine</strong> - Google開発（Chrome、Android, Edge）
            </li>
            <li><strong>FairPlay</strong> - Apple開発（Safari、iOS）</li>
          </ul>

          <h3>サイト例</h3>
          <p>アマプラビデオ</p>
          <p>U-NEXT</p>
        </section>

        <section>
          <h3>HLSを用いたlive配信</h3>
          <pre class="mermaid">
            sequenceDiagram
                participant Browser as ブラウザ
                participant MediaPackage as AWS MediaPackage<br/>(パッケージング・配信)
                participant MediaLive as AWS MediaLive<br/>(エンコード処理)
                participant Source as 配信元

                Source->>MediaLive: RTMP/SRT ライブストリーム
                MediaLive->>MediaLive: 動画エンコード・トランスコード
                MediaLive->>MediaPackage: エンコード済みストリーム
                MediaPackage->>MediaPackage: HLSセグメント化・マニフェスト生成
                
                loop 定期的なマニフェストチェック
                    Browser->>MediaPackage: GET /playlist.m3u8
                    MediaPackage-->>Browser: Just-in-Time生成マニフェスト
                    Note over Browser: 新しいセグメントを発見
                    Browser->>MediaPackage: GET /segment001.ts
                    MediaPackage-->>Browser: HLSセグメント
                    Browser->>Browser: セグメント再生
                end
                
                Note over MediaPackage: リアルタイムでマニフェスト更新
          </pre>
        </section>

        <!-- Video.js HLS Demo -->
        <section>
          <h3>Video.jsを使ってクロスブラウザでHLS再生</h3>

          <video-js
            id="videojs-hls-live-player"
            class="vjs-default-skin"
            controls
            preload="auto"
          >
          </video-js>
        </section>

        <section>
          <h3>Amazon IVS (Interactive Video Service)</h3>
          <ul>
            <li>AWS提供の超低遅延ライブストリーミングサービス</li>
            <li>Twitchと同じ技術基盤を使用</li>
            <li>WebRTCベースで1秒以下の遅延を実現</li>
            <li>インタラクティブな配信が可能</li>
          </ul>
        </section>

        <!-- IVS Player Demo -->
        <section>
          <h3>Video.js + IVS Player デモ</h3>

          <video-js
            id="ivs-player"
            class="vjs-default-skin"
            controls
            preload="auto"
            width="100%"
            height="3000"
          >
          </video-js>
        </section>

        <!-- まとめ -->
        <section>
          <h2>まとめ</h2>
          <ul>
            <li>VOD：録画済みコンテンツの配信</li>
            <li>Live：リアルタイム配信</li>
            <li>HLS：HTTPベースの効率的な配信技術</li>
            <li>セグメント化により柔軟な品質調整が可能</li>
          </ul>
        </section>

        <!-- ありがとうございました -->
        <section class="title-slide">
          <h1>ありがとうございました</h1>
          <p>質問はありますか？</p>
        </section>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/dist/reveal.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/plugin/notes/notes.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/plugin/markdown/markdown.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/plugin/highlight/highlight.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <!-- Video.js JavaScript -->
    <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>
    <!-- Amazon IVS Player Tech for Video.js -->
    <script src="https://player.live-video.net/1.41.0/amazon-ivs-videojs-tech.min.js"></script>
    <script>
      Reveal.initialize({
        hash: true,
        transition: "slide",
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes],
      });

      // Initialize Mermaid
      mermaid.initialize({ startOnLoad: true });

      // Initialize Video.js player
      Reveal.on("slidechanged", function (event) {
        var player = videojs("videojs-hls-player", {
          html5: {
            vhs: {
              withCredentials: true,
            },
          },
        });

        player.src({
          src: "https://video-playground-takata.s3.ap-southeast-2.amazonaws.com/video/mediaconvert/output.m3u8",
          type: "application/x-mpegURL",
          withCredentials: true,
        });

        var playerLive = videojs("videojs-hls-live-player", {
          html5: {
            vhs: {
              withCredentials: true,
            },
          },
        });

        playerLive.src({
          src: "https://814bffb9b389f652.mediapackage.ap-southeast-2.amazonaws.com/out/v1/e20f7a8b6b9e43cc8cb3905f0a39d9a4/index.m3u8",
          type: "application/x-mpegURL",
          withCredentials: true,
        });

        // Register Amazon IVS tech

        registerIVSTech(videojs);

        // Initialize IVS Player with Amazon IVS tech
        var ivsPlayer = videojs(
          "ivs-player",
          {
            techOrder: ["AmazonIVS"],
          },
          () => {
            // Set the IVS stream URL
            ivsPlayer.src(
              "https://e759d28da8d9.ap-northeast-1.playback.live-video.net/api/video/v1/ap-northeast-1.648078772342.channel.sC3cxpRBqR1t.m3u8"
            );
          }
        );
      });
    </script>
  </body>
</html>
